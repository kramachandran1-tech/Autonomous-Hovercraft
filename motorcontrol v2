
#include <Servo.h>
Servo esc;

// Ultrasonic pins
const int trigPin = 6;
const int echoPin = 7;

// ESC throttle levels (adjust to your ESC & motor)
const int minThrottle = 1500;
const int slowThrottle = 1600;
const int mediumThrottle = 1700;
const int fastThrottle = 1800;

// Ramping speed (microseconds per loop)
const int rampStep = 5;      // How much the throttle changes per step
const int rampDelay = 20;    // Delay for smoothness (ms)

int currentThrottle = minThrottle;

// ------------------------------
// Distance measurement (average)
// ------------------------------
float getFilteredDistance() {
  long total = 0;
  const int samples = 5;     // number of samples to average

  for (int i = 0; i < samples; i++) {
    // Trigger pulse
    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);
    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);

    long duration = pulseIn(echoPin, HIGH, 25000); // 25 ms timeout
    float d = duration * 0.034/2;                // cm

    total += d * 10; // store in mm to avoid float issues
    delay(10);
  }

  return (total / samples) / 10.0; // return distance in cm
}

// ------------------------------
// Ramping function
// ------------------------------//
/*
void rampTo(int targetThrottle) {
  if (currentThrottle < targetThrottle) {
    currentThrottle += rampStep;
  } else if (currentThrottle > targetThrottle) {
    currentThrottle -= rampStep;
  }

  // Limit bounds
  if (currentThrottle > 2000) currentThrottle = 2000;
  if (currentThrottle < minThrottle) currentThrottle = minThrottle;

  esc.writeMicroseconds(currentThrottle);
  delay(rampDelay);
}
*/
void setup() {
  Serial.begin(9600);

  esc.attach(9);
  delay(2000);
  Serial.println("ESC Ready");

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);

  esc.writeMicroseconds(minThrottle);  // safe idle
}

void loop() {

  float distance = getFilteredDistance();

  Serial.print("Distance (cm): ");
  Serial.print(distance);
  Serial.print("   Target Speed: ");

  // MULTI-LEVEL SPEED CONTROL
  if (distance < 15) {
    esc.writeMicroseconds(slowThrottle);
    Serial.println("SLOW");
  }
  else if (distance >= 15 && distance < 30) {
    esc.writeMicroseconds(mediumThrottle);
    Serial.println("MEDIUM");
  }
  else {
    esc.writeMicroseconds(fastThrottle);
    Serial.println("FAST");
  }
  delay(100);

  // Apply smooth ramping toward target speed
  //rampTo(targetThrottle);
}
